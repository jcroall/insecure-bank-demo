# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: self-hosted

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Run Coverity Full Scan (push)
        if: ${{github.event_name == 'push'}}
        run: |
          coverity scan
          cov-format-errors --dir idir --json-output-v8 coverityResults.json
          echo EXEC: node /home/jcroall/cov-analysis-linux64-2021.9.0/SARIF/cov-format-sarif-for-github --inputFile coverityResults.json --repoName jcroall/insecure-bank-demo --checkoutPath jcroall/insecure-bank-demo `pwd` $GITHUB_SHA --outputFile coverityResults-sarif.json
          node /home/jcroall/cov-analysis-linux64-2021.9.0/SARIF/cov-format-sarif-for-github --inputFile coverityResults.json --repoName jcroall/insecure-bank-demo --checkoutPath jcroall/insecure-bank-demo `pwd` $GITHUB_SHA --outputFile coverityResults-sarif.json
      
      - name: Upload SARIF file (push)
        if: ${{github.event_name == 'push'}}
        uses: github/codeql-action/upload-sarif@v1
        with:
          # Path to SARIF file relative to the root of the repository
          sarif_file: coverityResults-sarif.json

      - id: changeset
        if: ${{ github.event_name == 'pull_request' }}
        name: Get Pull Request Changeset
        uses: jitterbit/get-changed-files@v1
        continue-on-error: true
        
      - name: Run Coverity Incremental Scan (pull_request)
        if: ${{github.event_name == 'pull_request'}}
        run: |
          echo EXEC: coverity capture
          coverity capture
          
          echo EXEC: cov-run-desktop --dir idir --url https://local.cim.com --stream insecure-bank --ignore-uncapturable-inputs true --present-in-reference false --json-output-v7 coverityResults.json ${{ steps.changeset.outputs.added_modified }}
          cov-run-desktop --dir idir --url https://local.cim.com --stream insecure-bank --ignore-uncapturable-inputs true --present-in-reference false --json-output-v7 coverityResults.json ${{ steps.changeset.outputs.added_modified }}
          
          #echo EXEC: cov-commit-defects --url https://local.cim.com --auth-key-file /home/jcroall/.coverity/authkeys/ak-local.cim.com-443 --stream insecure-bank --preview-report-v2 coverityResults.json --dir idir
          #cov-commit-defects --url https://local.cim.com --auth-key-file /home/jcroall/.coverity/authkeys/ak-local.cim.com-443 --stream insecure-bank --preview-report-v2 coverityResults.json --dir idir
          
          #echo EXEC: cat coverityResults.json
          #cat coverityResults.json

          echo EXEC: node /home/jcroall/cov-analysis-linux64-2021.9.0/SARIF/cov-format-sarif-for-github --inputFile coverityResults.json --repoName jcroall/insecure-bank-demo --checkoutPath jcroall/insecure-bank-demo `pwd` $GITHUB_SHA --outputFile coverityResults-sarif.json
          node /home/jcroall/cov-analysis-linux64-2021.9.0/SARIF/cov-format-sarif-for-github --inputFile coverityResults.json --repoName jcroall/insecure-bank-demo --checkoutPath jcroall/insecure-bank-demo `pwd` $GITHUB_SHA --outputFile coverityResults-sarif.json
        continue-on-error: true

      - name: Upload SARIF file (pull_request)
        if: ${{github.event_name == 'pull_request'}}
        uses: github/codeql-action/upload-sarif@v1
        with:
          # Path to SARIF file relative to the root of the repository
          sarif_file: coverityResults-sarif.json
